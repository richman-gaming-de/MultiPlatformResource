name: Release
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Trigger bei Tags wie v1.0.0, v1.2.3

jobs:
  release:
    runs-on: [ self-hosted, richman-gaming ]
    permissions:
      contents: write # Wichtig: Erlaubt dem Workflow, Releases zu erstellen und Tags zu pushen

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 ist gut, wenn generate_release_notes: true verwendet wird,
          # da es den gesamten Git-Verlauf für die Commit-Analyse holt.
          fetch-depth: 0

      - name: Prepare AltV Release Directory
        run: |
          # Inhalt von src/ in das Zielverzeichnis kopieren
          # Der Stern '*' stellt sicher, dass NUR der Inhalt von src/ kopiert wird,
          # nicht der src/-Ordner selbst in assets/stream/
          cp -r src/* platformResourcePresets/altv/assets/stream/

          # Optional: Debugging - Zeigt den Inhalt des vorbereiteten Ordners
          echo "Content of platformResourcePresets/altv/assets/stream/ after copy:"
          ls -R platformResourcePresets/altv/assets/stream/
        shell: bash # Sicherstellen, dass Bash für cp/mkdir verwendet wird, besonders wichtig auf Windows-Runnern

      - name: Create AltV Release Archive (ZIP) 
        run: |
          ZIP_FILE_NAME="altv-resource-${{ github.ref_name }}.zip" # Benenne die ZIP-Datei dynamisch
          TARGET_FOLDER_TO_ZIP="platformResourcePresets/altv/" # Der Ordner, den wir zippen wollen

          echo "Creating ZIP archive for: $TARGET_FOLDER_TO_ZIP"
          echo "ZIP file will be named: $ZIP_FILE_NAME"

          # Wechsle das Verzeichnis ins übergeordnete Verzeichnis, damit 'altv/' im ZIP auf oberster Ebene ist
          cd $(dirname "$TARGET_FOLDER_TO_ZIP") # Geht zu 'platformResourcePresets/'
          zip -r "../$ZIP_FILE_NAME" $(basename "$TARGET_FOLDER_TO_ZIP") # Zippt 'altv/' und legt ZIP eine Ebene höher ab

          echo "Successfully created ZIP: $ZIP_FILE_NAME"
          # Debugging: Zeige die erstellte ZIP-Datei im Root-Verzeichnis des Workflows
          ls -l "../$ZIP_FILE_NAME"
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # Wir verwenden den vom Tag abgeleiteten Namen und fügen '-assets' an
          tag_name: ${{ github.ref_name }}-assets
          name: Release ${{ github.ref_name }} (Build Assets)
          draft: false
          prerelease: false
          # Generiert automatische Release-Notes basierend auf Commits
          generate_release_notes: true

          files: |
            altv-resource-${{ github.ref_name }}.zip
